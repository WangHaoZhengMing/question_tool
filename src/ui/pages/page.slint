
import { Switch, GridBox, ListView, ScrollView, HorizontalBox, VerticalBox, Palette, TextEdit, Button, GroupBox} from "std-widgets.slint";


export component Page inherits VerticalBox {
    in property <string> title: "Page";
    in property <string> description: "description";
    accessible-role: tab-panel;
    alignment: LayoutAlignment.stretch;
    accessible-label: root.title;

    in-out property <string> question_type: root.title;
    in-out property <string> prefill_text: "";
    in-out property <image> current_image;
    in-out property <string> model_reply: "";
    property <string> displayed_reply: "";
    in-out property <bool> is_streaming: false;
    callback send_message();
    callback copy_reply_and_addcode();
    callback stop_response();
    callback clear_image();
    // callback current_question_type();
    HorizontalBox {
        // 左栏：输入和图片
        
        GroupBox {
            title: root.title;
            VerticalBox {
                width: 100%;
                Rectangle {
                    // height: 200px;
                    min-width: 170px;
                    min-height: 50px;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: Palette.border;
                    TextEdit {
                        text <=> root.prefill_text;
                        placeholder-text: "请输入文本";
                        x: 0;
                        y: 0;
                        width: parent.width;
                        height: parent.height;
                    }

                    Button {
                        text: "发送";
                        width: 60px;
                        height: 30px;
                        primary: true;
                        enabled: !root.is_streaming;
                        x: parent.width - self.width - 8px;
                        y: parent.height - self.height - 8px;
                        clicked => {
                            root.send_message();
                        }
                    }
                    
                    Button {
                        text: "停止";
                        width: 60px;
                        height: 30px;
                        visible: root.is_streaming;
                        x: parent.width - self.width - 76px;
                        y: parent.height - self.height - 8px;
                        clicked => {
                            root.stop_response();
                        }
                    }
                }

                Rectangle {
                    height: 300px;
                    VerticalBox {
                        alignment: LayoutAlignment.start;
                        spacing: 5px;
                        
                        HorizontalBox {
                            alignment: LayoutAlignment.end;
                            visible: current_image.width > 0;
                            Button {
                                text: "清除图片";
                                width: 80px;
                                height: 28px;
                                clicked => {
                                    root.clear_image();
                                }
                            }
                        }
                        
                        Image {
                            source: current_image;
                            width: 50%;
                            height: parent.height - 35px;
                        }
                    }
                }
            }
        }

        
        // 右栏：模型回复
        GroupBox {
            title: "模型回复";
            VerticalBox {
                Rectangle {
                    min-width: 170px;
                    min-height: 50px;
                    border-radius: 4px;
                    TextEdit {
                        text: root.model_reply;
                        placeholder-text: "模型回复将显示在这里...";
                        read-only: true;
                        width: parent.width;
                        height: parent.height;
                        
                        // 添加流畅的内容变化动画
                        animate opacity {
                            duration: 200ms;
                            easing: ease-in-out;
                        }
                    }
                    
                    // 流式显示指示器
                    Rectangle {
                        visible: root.is_streaming;
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: Palette.accent-background;
                        x: parent.width - 20px;
                        y: parent.height - 20px;
                        
                        // 脉冲动画效果
                        animate width {
                            duration: 800ms;
                            easing: ease-in-out;
                        }
                        animate height {
                            duration: 800ms;
                            easing: ease-in-out;
                        }
                        Timer {
                            interval: 800ms;
                            running: root.is_streaming;
                            triggered => {
                                if (parent.width == 8px) {
                                    parent.width = 12px;
                                    parent.height = 12px;
                                } else {
                                    parent.width = 8px;
                                    parent.height = 8px;
                                }
                            }
                        }
                    }

                    Button {
                        text: "复制";
                        width: 50px;
                        height: 25px;
                        x: parent.width - self.width - 8px;
                        y: 8px;
                        clicked => {
                            root.copy_reply_and_addcode();
                        }
                    }
                    
                    Button {
                        text: "停止";
                        width: 50px;
                        height: 25px;
                        visible: root.is_streaming;
                        x: parent.width - self.width - 66px;
                        y: 8px;
                        clicked => {
                            root.stop_response();
                        }
                    }
                }
            }
        }
    }

    @children
}
